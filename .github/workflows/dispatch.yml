name: Dispatch
  
on: repository_dispatch
  
jobs:

  on_dispatch:
    name: On Dispatch
    runs-on: ubuntu-latest
    if: ${{ github.event.client_payload.branch == 'development' }}
    
    steps:
      - name: Log received event
        run: ${{ tojson(github.event) }}
        shell: cat {0}

      - name: Dispatch from ifc-gherkin-rules (development)
        run: echo "ifc-gherkin-rules (development branch)"
        if: ${{ github.event.client_payload.repo == 'ifc-gherkin-rules' && github.event.client_payload.branch == 'development' }}
        
      - name: Dispatch from ifc-validation-data-model (development)
        run: echo "ifc-validation-data-model (development branch)"
        if: ${{ github.event.client_payload.repo == 'ifc-validation-data-model' && github.event.client_payload.branch == 'development' }}

      - name: Checkout sources
        uses: actions/checkout@v4
      
      - name: Fetch latest submodules
        run: |
          cd ${{ github.workspace }}
          git submodule update --init --recursive
          git submodule update --remote
          cd backend/apps/ifc_validation/checks/ifc_gherkin_rules && git checkout -q ${{ github.event.client_payload.branch }} && git pull
          cd ./ifc_validation_models && git checkout -q ${{ github.event.client_payload.branch }} && git pull
          cd ${{ github.workspace }}/backend/apps/ifc_validation/checks/step_file_parser && git checkout -q master && git pull
          cd ${{ github.workspace }}/backend/apps/ifc_validation_models && git checkout -q ${{ github.event.client_payload.branch }} && git pull
          cd ${{ github.workspace }}
          ./check-submodules.sh
